---
title: "Mutating data"
output: html_notebook
---

# Mutating data

Often the data you have will prompt questions that it doesn't immediately answer. We may need to see how the population changed over time by census tract and the percentage change.

To do that in R, we can use `dplyr` and `mutate` to calculate new metrics in a new field using existing fields of data. That's the essence of `mutate` - using the data you have to answer a new question.

So first we'll import the tidyverse so we can read in our data and begin to work with it.

```{r}
library(tidyverse)
```

We'll import a dataset of median household income in Baltimore for the 2010, 2016 and 2020 surveys that is in the data folder in this chapter's pre-lab directory. We'll use this to explore ways to create new information from existing data.

```{r eval=FALSE, message=FALSE}

baltcity_income<- read_csv("https://raw.githubusercontent.com/profrobwells/Baltimore/main/baltcity_income_clean.csv") %>% 
  as.data.frame()

#need to redo this with paths for the downloaded repo
#baltcity_income <- read.csv('data/baltcity_income_clean.csv')
```

<!-- First, let's add a column called `percent_payroll` for the percentage of each loan application that payroll expenses represent. The code to calculate a percentage is pretty simple. Remember, with `summarize`, we used `n()` to count things. With `mutate`, we use very similar syntax to calculate a new value -- a new column of data -- using other values in our dataset. So in this case, we're trying to do , but we're doing it with fields. -->

<!-- If we look at what we got when we imported the data, you'll see there's `payroll_proceed` as the numerator, and we'll use `amount` as the denominator. -->

One main question involves how the median income changed from 2010 to 2020. First, let's add a column called `diff_2010_2020` to see how median income changed for each census tract. The code is pretty simple. Remember, with `summarize`, we used `n()` to count things. With `mutate`, we use very similar syntax to calculate a new value -- a new column of data -- using other values in our dataset. So in this case, we're trying to do, but we're doing it with fields.

If we look at what we got when we imported the data, you'll see there's `payroll_proceed` as the numerator, and we'll use `amount` as the denominator.

```{r}
# maryland_ppp %>%
#   select(loan_number, amount, payroll_proceed) %>%
#   mutate(
#   percent_payroll = payroll_proceed/amount
# )
```

```{r}
baltcity_income %>%
  select(Census, Neighborhood, x2010, x2020) %>%
    mutate(Diff_Income = (x2020-x2010))
```
Now we've got our `Diff_Income` column. This is fine but let's provide some context and use a percentage change calculation to compare the gains. We'll add a new column, `Diff_Pct_2020`. Remember the percentage change calculation is (New-Old)/Old

```{r}
baltcity_income %>%
  select(Census, Neighborhood, x2010, x2020) %>%
    mutate(Diff_Income = (x2020-x2010)) %>% 
    mutate(Diff_Pct_2020 = (x2020-x2010)/x2010)
  
```

Look at `Diff_Pct_2020` - what do you see right away? Do those numbers look like we expect them to? No. They're a decimal expressed as a percentage. So let's fix that by multiplying by 100.

```{r}
baltcity_income %>%
  select(Census, Neighborhood, x2010, x2020) %>%
    mutate(Diff_Income = (x2020-x2010)) %>% 
    mutate(Diff_Pct_2020 = (x2020-x2010)/x2010*100)
  
```

Now, does this ordering do anything for us? No. Let's fix that with arrange.

```{r}
baltcity_income %>%
  select(Census, Neighborhood, x2010, x2020) %>%
    mutate(Diff_Income = (x2020-x2010)) %>% 
    mutate(Diff_Pct_2020 = (x2020-x2010)/x2010*100) %>% 
    arrange(desc(Diff_Pct_2020))
  
```

So now we have Census tracts ordered by `Diff_Pct_2020` with the highest percentage first. So we know who the winners were. Which areas suffered the biggest declines in median income?

```{r}
baltcity_income %>%
  select(Census, Neighborhood, x2010, x2020) %>%
    mutate(Diff_Income = (x2020-x2010)) %>% 
    mutate(Diff_Pct_2020 = (x2020-x2010)/x2010*100) %>% 
    arrange(Diff_Pct_2020)
  
```


## Using mutate to clean data

For this example, we'll examine a dataset of loans small businesses obtained to stay afloat during the Covid-19 pandemic. It's called the PPP loan database which stands for Paycheck Protection Program loans.
```{r}
maryland_ppp <- read.csv("/Volumes/GoogleDrive/My Drive/Data Class Fall 2022/ppp_applications_md.csv")

#maryland_ppp <- read.csv('data/ppp_applications_md.csv')
```

Take a look at the `city` column in our data.

```{r eval=FALSE}
View(maryland_ppp)
```

You'll notice that there's a mix of styles: "Baltimore" and "BALTIMORE" for example. R will think those are two different cities, and that will mean that any aggregates we create based on city won't be accurate.

So how can we fix that? Mutate - it's not just for math! And a function called `str_to_upper` that will convert a character column into all uppercase.

```{r}
maryland_ppp %>%
  mutate(
    upper_city = str_to_upper(city)
) %>% 
   select(city, upper_city, name, amount)
```

Notice we kept the original data in `City` and transformed it in a new column, `upper_city`. Always a good practice to keep your original data intact in case you make a coding mistake or need to change the original for reference.

We could do the same thing with the `address` column in order to standardize that for analysis, too.

## A more powerful use

Mutate is even more useful when combined with some additional functions. Let's say you want to know if the servicing lender is located in Maryland or outside the state. There are three possible answers:

1. The lender is in Maryland
2. The lender is outside Maryland
3. The data doesn't tell us (`servicing_lender_state` is blank or NA)

We can create a new column that accounts for these possibilities and populate it using mutate and `case_when`, which is like an if/else statement but for more than two options.

```{r}
maryland_with_in_out <- maryland_ppp %>%
  mutate(
    in_out = case_when(
        servicing_lender_state == 'NA' ~ "NA",
        servicing_lender_state == 'MD' ~ "IN",
        servicing_lender_state != 'MD' ~ "OUT"
      )
  )
```

We can then use our new `in_out` column in group_by statements to make summarizing easier.

In this case there are no Maryland loans where `servicing_lender_state` has a value of 'NA', but you should never assume that will be the case for a dataset. If you know that the only options are the lender is in Maryland or is outside it, you can rewrite the previous code as an if/else statement:

```{r}
maryland_with_in_out <- maryland_ppp %>%
  mutate(
    in_out = if_else(
        servicing_lender_state == 'MD', "IN", "OUT"
      )
  )
```

Mutate is there to make your data more useful and to make it easier for you to ask more questions of it.


# Lab Questions:
Based on the skills you have learned above, use this dataset of Maryland cities
https://raw.githubusercontent.com/profrobwells/Baltimore/main/city_md_income.csv

And answer the following questions:


**Question #1: **

```{r}
 # 1) Calculate the difference in median income from 2010 to 2020 for all places listed. Calculate the percentage change. 
 # Which city had the highest absolute change? Which had the highest percentage change?
 # Produce a table with the top 25 places ranked by the highest percentage change.
 # Produce a second table with the top 25 places ranked by the lowest or negative percentage change.
```

**Question #2: **
```{r} 
 # 2) Calculate the difference in number of households from 2010 to 2020 for all places listed. Which city had the highest absolute change? Which had the highest percentage change? 
#Produce a table with the top 25 places ranked by the highest percentage change.
# Produce a second table with the top 25 places ranked by the lowest or negative percentage change.
 
```

**Question #3:**

```{r} 
 # 3) Examine the patterns of the places with the highest / lowest income growth and the / lowest highest growth in household population. Write a news story, 200-300 words, following AP style, with your findings. 
 
```



